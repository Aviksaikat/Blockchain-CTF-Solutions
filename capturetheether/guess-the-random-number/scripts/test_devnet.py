#!/usr/bin/python3
from scripts.deploy import  deploy_guess_random_num, get_account
import web3

def connect_web3_to_ganache():
    return web3.Web3(web3.Web3.HTTPProvider("http://127.0.0.1:8545"))

def guessRandomNum():
    # if network.show_active() == "ropsten":
    #     guess_num = chain.get_transaction(TRANSACTION_ID)
    
    guess_num = deploy_guess_random_num()
    #print(guess_num)
    #print(guess_num.isComplete())
    w3 = connect_web3_to_ganache()
    #print(dir(w3))
    
    contract_addr = guess_num.address
    transaction_id = guess_num.tx.txid
    block_number = guess_num.tx.block_number - 1 # prev block
    #time_stamp = guess_num.tx.timestamp
    #print(chain.get_transaction(contract_addr))
    #print(f"id : {guess_num.tx.txid}")
    #print(dir(guess_num.tx.block_number))
    
    #? our_deployed_contract_block_num = 12253759

    previous_block_hash = w3.eth.get_block(block_number).hash
    timestamp = w3.eth.get_block(block_number).timestamp
    answer_hash = w3.solidityKeccak(["bytes32", "uint256"], [previous_block_hash.hex(), timestamp]).hex() # 256 bit hexidecimal
    #print(answer_hash)
    answer_hash = answer_hash[-2:] # get 8 lowest order bits (last 2 hex)
    print(answer_hash)
    
    num = w3.toInt(hexstr = answer_hash)
    guessed_num = guess_num.answer()
    print(f"Random No generated by contract : {guessed_num}")
    print(f"The Random Number we found is : {num}")
    
    tx = guess_num.guess(num, {"from" : get_account(), "value" : web3.Web3.toWei("1", "ether")})
    tx.wait(1)
    print(f"Is complete : {guess_num.isComplete()}")


def main():
    guessRandomNum()